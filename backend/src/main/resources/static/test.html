<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.4.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

    <style>
        h4 {
            margin-block-start: 2em;
            margin-block-end: 0.5em;
        }
    </style>
</head>

<body>
    <form id="registForm" action="/regist" method="post">
        <input id="registIdentity" type="text" name="identity" placeholder="id">
        <input id="registPassword" type="password" name="password" placeholder="password">
        <input id="registName" type="text" name="name" placeholder="name">
        <input id="registEmail" type="text" name="email" placeholder="email">
        <button type="button" id="idCheck">IdCheck</button>
        <button type="button" id="sendMail">SendMail</button>
        <input type="submit" value="regist">
    </form>

    <form id="emailForm" action="/checkEmailauth" method="post">
        <input id="emailEmail" type="hidden" name="email">
        <input id="emailToken" type="text" name="token" placeholder="emailToken">
        <input type="submit" value="check">
    </form>

    <form id="loginForm" action="/login" method="post">
        <input id="loginIdentity" type="text" name="identity" placeholder="id">
        <input id="loginPassword" type="password" name="password" placeholder="password">
        <input type="submit" value="login">
    </form>

    <!-- <div>
        <button id="existToken">ExistToken</button>
    </div> -->

    <div>
        <button id="refreshToken">RefreshToken</button>
    </div>

    <div id="ledger">
        <h4>Ledger</h4>
        <button id="getLedger">GET</button>
        <button id="getLedgers">GETS</button>
        <button id="postLedger">POST</button>
        <button id="putLedger">PUT</button>
        <button id="deleteLedger">DELETE</button>
        <button id="getLedgersSumGroupByMonth">GET SUM GROUP BY MONTH</button>
        <button id="getLedgersTop5">GET TOP 5</button>
    </div>

    <div id="category">
        <h4>Category</h4>
        <button id="getCategory">GET</button>
        <button id="getCategorys">GETS</button>
        <button id="postCategory">POST</button>
        <button id="putCategory">PUT</button>
        <button id="deleteCategory">DELETE</button>
    </div>

    <div id="terms">
        <h4>Terms</h4>
        <button id="getTerms">GET</button>
        <button id="getTermss">GETS</button>
        <button id="postTerms">POST</button>
        <button id="putTerms">PUT</button>
        <button id="deleteTerms">DELETE</button>
    </div>
</body>

<script>
    var token;
    var refreshToken;

    $(function () {
        $('#registForm').on('submit', function (e) {
            e.preventDefault();

            $.ajax({
                type: 'post',
                url: '/regist',
                data: JSON.stringify(dataFormToJson('#registForm')),
                contentType: "application/json",
                complete: function (json) {
                    console.log(json.responseJSON);
                }
            });
        });

        $('#loginForm').on('submit', function (e) {
            e.preventDefault();

            $.ajax({
                type: 'post',
                url: '/login',
                data: JSON.stringify(dataFormToJson('#loginForm')),
                contentType: "application/json",
                success: function (json) {
                    console.log(json);
                    if(json.response == "success"){
                        token = json.data.accessToken;
                        refreshToken = json.data.refreshToken;
                    }
                },
                error: function (json) {
                    console.log(json);
                }
            });
        });

        // $('#existToken').on('click', function (e) {
        //     $.ajax({
        //         type: 'post',
        //         url: '/restapi/existToken',
        //         beforeSend: function (xhr) {
        //             xhr.setRequestHeader("Authorization", "Bearer " + token);
        //         },
        //         contentType: "application/json",
        //         success: function (json) {
        //             console.log(json);
        //         },
        //         error: function (json) {
        //             console.log(json);
        //         }
        //     });
        // });

        $('#sendMail').on('click', function (e) {
            $.ajax({
                type: 'post',
                url: '/sendEmailauth',
                data: {
                    to: $('#registEmail').val(),
                },
                success: function (json) {
                    console.log(json);
                    $('#emailEmail').val($('#registEmail').val());
                },
                error: function (json) {
                    console.log(json);
                }
            });
        });

        $('#emailForm').on('submit', function (e) {
            e.preventDefault();

            $.ajax({
                type: 'post',
                url: '/checkEmailauth',
                data: JSON.stringify(dataFormToJson('#emailForm')),
                contentType: "application/json",
                success: function (json) {
                    console.log(json);
                },
                error: function (json) {
                    console.log(json);
                }
            });
        });

        $('#idCheck').on('click', function (e) {
            $.ajax({
                type: 'post',
                url: '/checkId',
                data: {
                    identity: $('#registIdentity').val(),
                },
                complete: function (json) {
                    console.log(json.responseJSON);
                }
                // success : function(json){
                //     alert(json.message);
                //     console.log(json);
                // },
                // error : function(json){
                //     alert(json.message);
                //     console.log(json);
                // }
            });
        });

        $('#refreshToken').on('click', function (e) {
            $.ajax({
                type: 'post',
                url: '/refresh',
                data: JSON.stringify({
                    refreshToken: refreshToken,
                }),
                contentType: "application/json",
                success: function (json) {
                    console.log(json);
                    token = json.data;
                },
                error: function (json) {
                    console.log(json);
                }
            });
        });

        var ledgerObject = {
            title: "appTest",
            price: 99999999,
            categoryId: 11,
            kind: 2,
            payment: 2,
            date: "2022-07-08T14:27:16"
        }

        $('#ledger > #getLedger').on("click", function () {
            targetUrl = '/api/ledger/item';
            ledgerObject["id"] = 19;
            callLedger(targetUrl, 'get', ledgerObject);
        });

        $('#ledger > #postLedger').on("click", function () {
            targetUrl = '/api/ledger/item';
            callLedger(targetUrl, 'post', ledgerObject);
        });

        $('#ledger > #putLedger').on("click", function () {
            targetUrl = '/api/ledger/item';
            ledgerObject["id"] = 55;
            ledgerObject["title"] = "appTestPut";
            ledgerObject["categoryId"] = 11;
            callLedger(targetUrl, 'put', ledgerObject);
        });

        $('#ledger > #deleteLedger').on("click", function () {
            targetUrl = '/api/ledger/item';
            ledgerObject["id"] = 19;
            callLedger(targetUrl, 'delete', ledgerObject);
        });

        $('#ledger > #getLedgers').on("click", function () {
            targetUrl = '/api/ledger/items';
            callLedger(targetUrl, 'get', ledgerObject);
        });

        $('#ledger > #getLedgersSumGroupByMonth').on("click", function () {
            targetUrl = '/api/ledger/items/groupbymonth';
            callLedger(targetUrl, 'get');
        });

        $('#ledger > #getLedgersTop5').on("click", function () {
            targetUrl = '/api/ledger/items/top5';
            callLedger(targetUrl, 'get');
        });


        var categoryObject = {
            name: "categoryTest",
            color: "#FFFFFF"
        }

        $('#category > #getCategory').on("click", function () {
            targetUrl = '/api/category/item';
            categoryObject["id"] = 14;
            callCategory(targetUrl, 'get', categoryObject);
        });

        $('#category > #postCategory').on("click", function () {
            targetUrl = '/api/category/item';
            callCategory(targetUrl, 'post', categoryObject);
        });

        $('#category > #putCategory').on("click", function () {
            targetUrl = '/api/category/item';
            categoryObject["id"] = 14;
            categoryObject["name"] = "categoryTestPut";
            categoryObject["color"] = "#000000";
            callCategory(targetUrl, 'put', categoryObject);
        });

        $('#category > #deleteCategory').on("click", function () {
            targetUrl = '/api/category/item';
            categoryObject["id"] = 14;
            callCategory(targetUrl, 'delete', categoryObject);
        });

        $('#category > #getCategorys').on("click", function () {
            targetUrl = '/api/category/items';
            callCategory(targetUrl, 'get', categoryObject);
        });

        var termsObject = {
            title: "testTitle",
            content: "testContent",
            require: true
        }

        $('#terms > #getTerms').on("click", function () {
            targetUrl = '/api/terms/item';
            termsObject["id"] = 5;
            callTerms(targetUrl, 'get', termsObject);
        });

        $('#terms > #postTerms').on("click", function () {
            targetUrl = '/api/terms/item';
            callTerms(targetUrl, 'post', termsObject);
        });

        $('#terms > #putTerms').on("click", function () {
            targetUrl = '/api/terms/item';
            termsObject["id"] = 5;
            termsObject["content"] = "testContentPut";
            termsObject["require"] = false;
            callTerms(targetUrl, 'put', termsObject);
        });

        $('#terms > #deleteTerms').on("click", function () {
            targetUrl = '/api/terms/item';
            termsObject["id"] = 5;
            callTerms(targetUrl, 'delete', termsObject);
        });

        $('#terms > #getTermss').on("click", function () {
            targetUrl = '/api/terms/items';
            callTerms(targetUrl, 'get', termsObject);
        });
    });

    function callLedger(targetUrl, methodType, ledgerObject){
        var inputData;
        if(methodType == 'get'){
            inputData = ledgerObject;
        }
        else{
            inputData = JSON.stringify(ledgerObject);
        }

        $.ajax({
            type: methodType,
            url: targetUrl,
            data: inputData,
            contentType: "application/json",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " + token);
            },
            success: function (json) {
                console.log(json);
            },
            error: function (json) {
                console.log(json);
            }
        });
    }

    function callCategory(targetUrl, methodType, categoryObject){
        var inputData;
        if(methodType == 'get'){
            inputData = categoryObject;
        }
        else{
            inputData = JSON.stringify(categoryObject);
        }

        $.ajax({
            type: methodType,
            url: targetUrl,
            data: inputData,
            contentType: "application/json",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " + token);
            },
            success: function (json) {
                console.log(json);
            },
            error: function (json) {
                console.log(json);
            }
        });
    }

    function callTerms(targetUrl, methodType, termsObject){
        var inputData;
        if(methodType == 'get'){
            inputData = termsObject;
        }
        else{
            inputData = JSON.stringify(termsObject);
        }

        $.ajax({
            type: methodType,
            url: targetUrl,
            data: inputData,
            contentType: "application/json",
            beforeSend: function (xhr) {
                xhr.setRequestHeader("Authorization", "Bearer " + token);
            },
            success: function (json) {
                console.log(json);
            },
            error: function (json) {
                console.log(json);
            }
        });
    }

    function dataFormToJson(formTag) {
        var data = "";

        $.each($(formTag).serializeArray(), function (key, val) {
            data += ',"' + val['name'] + '":"' + val['value'] + '"';
        });
        data = '{' + data.substr(1) + '}';

        return JSON.parse(data);
    }
</script>